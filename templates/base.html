<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ api.static_url('style/spectre.min.css')}}">
  <link rel="stylesheet" href="{{ api.static_url('style/spectre-exp.min.css')}}">
  <link rel="stylesheet" href="{{ api.static_url('style/spectre-icons.min.css')}}">
</head>
<body>
  <div class="container grid-lg" id="app" v-cloak>
    <h1 class="page-title">{{ app.ctf_name }}</h1>
    <header class="navbar">
      <section class="navbar-section" v-if="user">
        <a href="" class="btn btn-link">Rule</a>
        <router-link to="/challenges" class="btn btn-link">Challenges</router-link>
        <a href="" class="btn btn-link">Scoreboard</a>
      </section>
      <section class="navbar-section" v-else>
        <a href="" class="btn btn-link">Rule</a>
        <a href="" class="btn btn-link">Scoreboard</a>
      </section>

      <section class="navbar-section" v-if="user">
        <router-link to="/user" class="btn btn-link">[[ user.name ]]</router-link>
        <router-link to="/team" class="btn btn-link" v-if="user.team">[[ user.team ]]</router-link>
        <button @click="logout" class="btn btn-link">Logout</button>
      </section>
      <section class="navbar-section" v-else>
        <router-link to="/login" class="btn btn-link">Login</router-link>
        <router-link to="/register" class="btn btn-link">Register</router-link>
      </section>
    </header>

    <main>
      <ul>
        <li v-for="m in messages">[[ m ]]</li>
      </ul>
      <ul>
        <li v-for="e in errors">[[ e ]]</li>
      </ul>
      <router-view></router-view>
    </main>

  </div>

  <script src="{{ api.static_url('script/vue.js') }}"></script>
  <script src="{{ api.static_url('script/vue-router.js') }}"></script>
  <script src="{{ api.static_url('script/vuex.js') }}"></script>
  <script src="{{ api.static_url('script/axios.min.js') }}"></script>
  <script src="{{ api.static_url('pages/index.js') }}"></script>
  <script src="{{ api.static_url('pages/login.js') }}"></script>
  <script src="{{ api.static_url('pages/register.js') }}"></script>
  <script src="{{ api.static_url('pages/myteam.js') }}"></script>
  <script src="{{ api.static_url('pages/me.js') }}"></script>
  <script src="{{ api.static_url('pages/challenges.js') }}"></script>

  <script>
    function getCookie(name) {
      var value = "; " + document.cookie;
      var parts = value.split("; " + name + "=");
      if (parts.length == 2) return parts.pop().split(";").shift();
    }

    Vue.use(VueRouter);
    Vue.use(Vuex);

    const api = axios.create({
      baseURL: '{{ base_url }}',
      withCredentials: true,
    })

    const store = new Vuex.Store({
      state: {
        login: false,
        user: null,
        team: null,
        challenges: [],

        errors: [],
        messages: [],
      },
      getters: {
      },
      mutations: {
        setLogin(state, login) {
          state.login = login
        },
        setUser(state, user) {
          state.user = user
        },
        setTeam(state, team) {
          state.team = team
        },
        setMessages(state, messages) {
          state.errors = []
          state.messages = messages
        },
        setErrors(state, errors) {
          state.messages = []
          state.errors = errors
        },
        setMessags(state, messages) {
          state.messages = messages
        },
        logout(state) {
          state.login = false
          state.user = null
        },
        setChallenges(state, challenges) {
          state.challenges = challenges
        }
      },
      actions: {
        login(context) {
          api.get('me')
            .then(r => {
              context.commit('setLogin', true)
              context.commit('setUser', r.data['user'])
            })
            .catch(e => {console.log(e)})
        }
      },
    })

    const routes = [
      {
        path: '/',
        component: index,
      },
      {
        path: '/login',
        component: login,
      },
      {
        path: '/register',
        component: register,
      },
      {
        path: '/team',
        component: myteam,
      },
      {
        path: '/user',
        component: me,
      },
      {
        path: '/challenges',
        component: challenges,
      },
    ];
    const router = new VueRouter({routes: routes});
    let vue = new Vue({
      el: '#app',
      store: store,
      router: router,
      delimiters: ['[[', ']]'],
      methods: {
        logout() {
          document.cookie = 'user=; max-age=0'
          this.$store.commit('logout')
          this.$router.push('/login')
        },
      },
      computed: {
        messages() {
          return this.$store.state.messages
        },
        errors() {
          return this.$store.state.errors
        },
        user() {
          if (this.$store.state.login) {
            return this.$store.state.user
          }
          return null
        }

      },
      mounted() {
        let cookie = getCookie('user');
        if (cookie) {
          this.$store.dispatch('login')
        }
      },
      watch: {
        $route (to, from) {
          this.$store.commit('setErrors', []);
        }
      }
    });

  </script>
</body>
</html>
